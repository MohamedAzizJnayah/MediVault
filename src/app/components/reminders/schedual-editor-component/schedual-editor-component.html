<div class="bg-white rounded-2xl border shadow-sm p-5">

  <div class="mb-4">
    <h2 class="text-lg font-semibold text-gray-800">Schedule editor</h2>
    <p class="text-sm text-gray-500">Choose a medication and set daily times.</p>
  </div>

  @if (error) {
    <div class="mb-4 rounded-xl border border-red-200 bg-red-50 p-3 text-red-700">
      {{ error }}
    </div>
  }

  @if (message) {
    <div class="mb-4 rounded-xl border border-green-200 bg-green-50 p-3 text-green-700">
      {{ message }}
    </div>
  }

  @if (loading) {
    <div class="rounded-xl border bg-gray-50 p-4 text-gray-600">Loading...</div>
  } @else {

    <form [formGroup]="form" class="space-y-4">

      <!-- Select medication -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Medication</label>
        <select
          class="w-full px-4 py-2 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:outline-none"
          formControlName="medicationId"
          (change)="onSelectMedication(form.controls.medicationId.value)"
        >
          <option value="" disabled>Select medication...</option>
          @for (m of medications; track m.id) {
            <option [value]="m.id">{{ m.name }}</option>
          }
        </select>
      </div>

      @if (selectedMedication) {

        <!-- Frequency + generate -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Frequency / day</label>
            <input type="number"
                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                   formControlName="frequencyPerDay" />
            @if (form.controls.frequencyPerDay.touched && form.controls.frequencyPerDay.invalid) {
              <p class="text-xs text-red-500 mt-1">Frequency must be â‰¥ 1</p>
            }
          </div>

          <div class="md:col-span-2 flex items-end gap-2">
            <button type="button"
                    (click)="generateTimesFromFrequency()"
                    class="px-4 py-2 rounded-lg border hover:bg-gray-50">
              Auto-generate times
            </button>

            <button type="button"
                    (click)="addTime()"
                    class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">
              + Add time
            </button>
          </div>
        </div>

        <!-- Times list -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Times (HH:MM)</label>

          <div class="space-y-2">
            @for (ctrl of timesArray.controls; track $index) {
              <div class="flex items-center gap-2">
                <input
                  class="w-40 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                  [formControl]="ctrl"
                  placeholder="08:00"
                />

                <button type="button"
                        class="px-3 py-2 rounded-lg border hover:bg-gray-50"
                        (click)="removeTime($index)">
                  Remove
                </button>

                @if (ctrl.touched && ctrl.invalid) {
                  <span class="text-xs text-red-500">Format HH:MM</span>
                }
              </div>
            }
          </div>
        </div>

        <!-- Dates -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Start date</label>
            <input type="date"
                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                   formControlName="startDate" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">End date (optional)</label>
            <input type="date"
                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                   formControlName="endDate" />
          </div>
        </div>

        <!-- Save -->
        <div class="flex justify-end">
          <button type="button"
                  (click)="save()"
                  [disabled]="saving"
                  class="px-5 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 disabled:bg-gray-300">
            @if (saving) { Saving... } @else { Save schedule }
          </button>
        </div>

      } @else {
        <div class="rounded-xl border border-dashed bg-gray-50 p-6 text-center text-gray-500">
          Select a medication to edit its schedule.
        </div>
      }

    </form>
  }
</div>
